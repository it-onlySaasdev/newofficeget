name: Deploy to Skynet

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Upload to Skynet
      run: |
        # Create zip of the entire site (excluding .git folder)
        zip -r site.zip . -x "*.git*" "*.github*"
        
        # Upload to Skynet using the correct API endpoint
        echo "Uploading to Skynet..."
        RESPONSE=$(curl -s -X POST "https://siasky.net/skynet/skyfile" -F "file=@site.zip")
        echo "Raw Response: $RESPONSE"
        
        # Try to extract skylink from JSON response
        SKYLINK=$(echo $RESPONSE | grep -o '"skylink":"[^"]*"' | cut -d'"' -f4)
        
        # If no skylink found, try alternative extraction
        if [ -z "$SKYLINK" ]; then
          SKYLINK=$(echo $RESPONSE | grep -o 'skylink[^,]*' | cut -d'"' -f3)
        fi
        
        # Output results
        if [ -n "$SKYLINK" ]; then
          echo "‚úÖ Deployment successful!"
          echo "üåê Live URL: https://siasky.net/$SKYLINK"
          echo "üîó Direct Skylink: $SKYLINK"
          
          # Save URL to job summary
          echo "## üöÄ Your site is now live!" >> $GITHUB_STEP_SUMMARY
          echo "**Live URL:** https://siasky.net/$SKYLINK" >> $GITHUB_STEP_SUMMARY
          echo "**Skylink:** $SKYLINK" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå Deployment failed. Response:"
          echo "$RESPONSE"
        fi