name: Deploy to Skynet

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Upload to Skynet
      run: |
        # Create zip of the entire site
        zip -r site.zip .
        
        # Upload to Skynet and get FULL response
        echo "Uploading to Skynet..."
        RESPONSE=$(curl -s -X POST "https://siasky.net/skynet/skyfile" -F "file=@site.zip")
        echo "Full Response: $RESPONSE"
        
        # Extract skylink using multiple methods
        SKYLINK=$(echo $RESPONSE | grep -o '"skylink":"[^"]*"' | cut -d'"' -f4)
        
        # If first method failed, try alternative method
        if [ -z "$SKYLINK" ]; then
          SKYLINK=$(echo $RESPONSE | grep -o '"skylink":"[^"]*"' | head -1 | sed 's/"skylink":"//' | sed 's/"//')
        fi
        
        # Output results
        echo "‚úÖ Deployment successful!"
        echo "üåê Live URL: https://siasky.net/$SKYLINK"
        echo "üîó Direct Skylink: $SKYLINK"
        
        # Save URL to job summary
        echo "## üöÄ Your site is now live!" >> $GITHUB_STEP_SUMMARY
        echo "**Live URL:** https://siasky.net/$SKYLINK" >> $GITHUB_STEP_SUMMARY
        echo "**Skylink:** $SKYLINK" >> $GITHUB_STEP_SUMMARY
        
        # If still no skylink, show full response for debugging
        if [ -z "$SKYLINK" ]; then
          echo "‚ùå Could not extract Skylink. Full response:"
          echo "$RESPONSE"
        fi